<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Witness | Settings</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --apple-red: #FF3B30; --bg: #fbfbfd; --text: #1c1c1e; --card: rgba(255, 255, 255, 0.75); --border: rgba(0, 0, 0, 0.08); --btn-bg: #1c1c1e; --btn-text: #ffffff; }
        .dark { --bg: #000000; --text: #ffffff; --card: rgba(28, 28, 30, 0.85); --border: rgba(255, 255, 255, 0.12); --btn-bg: #ffffff; --btn-text: #000000; }
        
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; transition: background 0.4s ease; }
        .page-container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        .glass-card { background: var(--card); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--border); border-radius: 2rem; padding: 2rem; width: 100%; }
        
        #mini-map { height: 220px; width: 100%; border-radius: 1.5rem; margin-top: 1.5rem; border: 1px solid var(--border); display: none; }
        .dark .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }

        .btn-main { background: var(--btn-bg); color: var(--btn-text); padding: 16px; rounded-2xl: 1.25rem; font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; width: 100%; transition: all 0.2s; }
        .btn-secondary { background: rgba(120, 120, 128, 0.16); color: var(--text); padding: 16px; border-radius: 1.25rem; font-weight: 800; font-size: 14px; text-transform: uppercase; width: 100%; }
        
        #search-results { position: absolute; width: 100%; z-index: 100; top: 100%; background: var(--card); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 1rem; overflow: hidden; margin-top: 4px; }
        .search-item { padding: 14px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 13px; }

        .step-hidden { display: none !important; }
    </style>
</head>
<body class="p-6">

    <div class="page-container">
        <header class="flex justify-between items-center mb-12">
            <a href="index.html" class="font-black text-xl tracking-tighter uppercase">Witness</a>
            <button onclick="toggleMode()" id="theme-icon" class="w-10 h-10 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center">üåô</button>
        </header>

        <h1 class="text-4xl font-black uppercase mb-10 tracking-tight">Settings</h1>

        <div class="glass-card mb-10">
            <div class="flex justify-between items-center mb-8">
                <h2 class="font-black text-lg uppercase tracking-tight">Watch Zones</h2>
                <span id="zone-counter" class="text-[10px] font-black opacity-40 uppercase tracking-widest">0 / 5</span>
            </div>

            <div id="zone-list" class="space-y-3 mb-10"></div>

            <div id="add-ui" class="pt-6 border-t border-zinc-100 dark:border-zinc-900">
                
                <div id="step-1" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search address..." class="w-full bg-transparent border-b border-zinc-200 py-3 outline-none text-sm font-medium">
                        <div id="search-results" class="hidden"></div>
                    </div>
                    <button onclick="useCurrentLocation()" class="btn-secondary">Use Current Location</button>
                </div>

                <div id="step-2" class="step-hidden space-y-4">
                    <div id="mini-map"></div>
                    <input type="text" id="zone-name-input" placeholder="Give this zone a name (e.g. Home)" class="w-full bg-transparent border-b border-zinc-200 py-3 outline-none text-sm font-medium">
                    <div class="flex gap-2">
                        <button onclick="resetFlow()" class="btn-secondary">Back</button>
                        <button onclick="confirmAndSaveZone()" class="btn-main" style="background: var(--apple-red); color: white;">Confirm & Save</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="glass-card">
            <h2 class="font-black text-lg uppercase tracking-tight mb-4 text-red-600">Danger Zone</h2>
            <button onclick="purgeAllData()" class="w-full border-2 border-red-600 text-red-600 py-4 rounded-2xl font-black text-xs uppercase tracking-widest">Wipe Device Data</button>
        </div>
    </div>

    <script>
        const supabaseUrl = "https://qburnwsfauymwwwpmjoo.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJud3NmYXV5bXd3d3Btam9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NDk2MzUsImV4cCI6MjA4NzMyNTYzNX0.auc2wgNolEGIsIzUsEfTgyVPS-whImFRxePCtmDBbTA";

        if (!localStorage.getItem('witness_device_id')) {
            localStorage.setItem('witness_device_id', crypto.randomUUID());
        }
        const deviceID = localStorage.getItem('witness_device_id');

        const sb = supabase.createClient(supabaseUrl, supabaseKey, {
            global: { headers: { 'x-device-id': deviceID } }
        });

        let miniMap, selectionMarker, selectedCoords = null;
        let zones = [];

        // FLOW CONTROL
        function resetFlow() {
            document.getElementById('step-1').classList.remove('step-hidden');
            document.getElementById('step-2').classList.add('step-hidden');
            document.getElementById('mini-map').style.display = 'none';
            selectedCoords = null;
        }

        function proceedToStep2(lat, lon, defaultName = "") {
            selectedCoords = { lat, lon };
            document.getElementById('step-1').classList.add('step-hidden');
            document.getElementById('step-2').classList.remove('step-hidden');
            document.getElementById('zone-name-input').value = defaultName;
            
            initMiniMap(lat, lon);
        }

        function initMiniMap(lat, lon) {
            document.getElementById('mini-map').style.display = 'block';
            if (!miniMap) {
                miniMap = L.map('mini-map', { zoomControl: false, attributionControl: false }).setView([lat, lon], 18);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(miniMap);
            } else {
                miniMap.setView([lat, lon], 18);
            }
            if (selectionMarker) miniMap.removeLayer(selectionMarker);
            selectionMarker = L.marker([lat, lon]).addTo(miniMap);
            setTimeout(() => miniMap.invalidateSize(), 100);
        }

        // LOCATION SEARCH
        const searchInput = document.getElementById('search-input');
        const resultsBox = document.getElementById('search-results');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            if (query.length < 3) return resultsBox.classList.add('hidden');
            const s = document.createElement('script');
            s.src = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&json_callback=handleSearch`;
            document.body.appendChild(s);
            document.body.removeChild(s);
        });

        window.handleSearch = function(data) {
            resultsBox.innerHTML = '';
            if (!data.length) return;
            resultsBox.classList.remove('hidden');
            data.forEach(p => {
                const div = document.createElement('div');
                div.className = 'search-item hover:bg-zinc-100 dark:hover:bg-zinc-800';
                div.innerText = p.display_name;
                div.onclick = () => {
                    resultsBox.classList.add('hidden');
                    proceedToStep2(parseFloat(p.lat), parseFloat(p.lon), p.display_name.split(',')[0]);
                };
                resultsBox.appendChild(div);
            });
        };

        function useCurrentLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                proceedToStep2(pos.coords.latitude, pos.coords.longitude, "My Current Location");
            }, err => alert("Please enable location access."));
        }

        // BACKEND BURST
        async function fetchZones() {
            const { data, error } = await sb.from('subscriptions').select('*').eq('device_id', deviceID);
            if (data) { zones = data; renderZones(); }
            if (error) console.error("Fetch failed:", error.message);
        }

        async function confirmAndSaveZone() {
            const name = document.getElementById('zone-name-input').value.trim();
            if (!name) return alert("Please enter a name.");
            if (zones.length >= 5) return alert("Limit of 5 zones reached.");

            const burstData = {
                device_id: deviceID,
                zone_name: name,
                lat_int: Math.floor(selectedCoords.lat),
                lon_int: Math.floor(selectedCoords.lon),
                lat_decimal: selectedCoords.lat,
                lon_decimal: selectedCoords.lon,
                push_token: "WEB_BURST_VERIFIED"
            };

            const { error } = await sb.from('subscriptions').insert([burstData]);

            if (error) {
                alert("Error: " + error.message);
            } else {
                resetFlow();
                fetchZones(); // Verify it works by re-fetching
            }
        }

        async function deleteZone(id) {
            const { error } = await sb.from('subscriptions').delete().eq('id', id);
            if (!error) fetchZones();
        }

        function renderZones() {
            const list = document.getElementById('zone-list');
            document.getElementById('zone-counter').innerText = `${zones.length} / 5`;
            list.innerHTML = zones.map(z => `
                <div class="flex justify-between items-center p-4 bg-zinc-50 dark:bg-zinc-900 rounded-2xl border border-black/5">
                    <div><p class="font-bold text-sm">${z.zone_name}</p><p class="text-[10px] opacity-40 uppercase font-black">${z.lat_decimal.toFixed(3)}, ${z.lon_decimal.toFixed(3)}</p></div>
                    <button onclick="deleteZone('${z.id}')" class="text-[10px] font-black text-red-600 uppercase">Remove</button>
                </div>
            `).join('');
        }

        // THEME
        function toggleMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            document.getElementById('theme-icon').innerText = isDark ? "‚òÄÔ∏è" : "üåô";
            localStorage.setItem('witness_theme', isDark ? 'dark' : 'light');
        }
        if (localStorage.getItem('witness_theme') === 'dark') {
            document.body.classList.add('dark');
            document.getElementById('theme-icon').innerText = "‚òÄÔ∏è";
        }

        fetchZones();
    </script>
</body>
</html>