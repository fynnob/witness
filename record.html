<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Oversight | Secure Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --apple-blue: #007AFF; }
        body { background: #000; color: #fff; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        .triage-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px); transition: all 0.3s ease; }
        .triage-card:active { transform: scale(0.96); background: rgba(255,255,255,0.1); }
        #video-preview { object-fit: cover; width: 100vw; height: 100vh; position: absolute; inset: 0; z-index: 1; display: none; }
        .recording-dot { width: 10px; height: 10px; background: #ff3b30; border-radius: 50%; box-shadow: 0 0 10px #ff3b30; }
    </style>
</head>
<body class="antialiased">

    <video id="video-preview" autoplay muted playsinline></video>

    <div id="triage-screen" class="relative z-10 h-screen flex flex-col justify-end p-8 pb-16 bg-gradient-to-b from-transparent to-black/80">
        <div class="mb-10 text-center">
            <h1 class="text-3xl font-black tracking-tight">EVIDENCE CAPTURE</h1>
            <p class="text-zinc-400 mt-2">Select environment to begin encrypted stream</p>
        </div>

        <div class="grid grid-cols-1 gap-4 w-full max-w-md mx-auto">
            <button onclick="initCapture('Residential')" class="triage-card p-6 rounded-[2rem] flex items-center gap-5">
                <span class="text-3xl">üè†</span>
                <div class="text-left">
                    <p class="font-bold text-lg">Residential</p>
                    <p class="text-xs text-zinc-500 uppercase font-black">Private Property</p>
                </div>
            </button>
            <button onclick="initCapture('Street')" class="triage-card p-6 rounded-[2rem] flex items-center gap-5">
                <span class="text-3xl">üöò</span>
                <div class="text-left">
                    <p class="font-bold text-lg">Street / Vehicle</p>
                    <p class="text-xs text-zinc-500 uppercase font-black">Public Way</p>
                </div>
            </button>
            <button onclick="initCapture('Workplace')" class="triage-card p-6 rounded-[2rem] flex items-center gap-5">
                <span class="text-3xl">üè¢</span>
                <div class="text-left">
                    <p class="font-bold text-lg">Work / Public Bldg</p>
                    <p class="text-xs text-zinc-500 uppercase font-black">Professional</p>
                </div>
            </button>
        </div>
    </div>

    <div id="recording-overlay" class="hidden relative z-20 h-screen pointer-events-none flex flex-col justify-between p-8">
        <div class="flex justify-between items-start pointer-events-auto">
            <div class="bg-black/40 backdrop-blur-xl border border-white/10 px-4 py-2 rounded-full flex items-center gap-3">
                <div class="recording-dot animate-pulse"></div>
                <span class="text-[10px] font-black uppercase tracking-widest text-red-500">Encrypted Stream</span>
            </div>
            <button onclick="stopAndFinalize()" class="bg-white text-black px-6 py-2 rounded-full font-bold text-sm">FINISH</button>
        </div>

        <div class="bg-black/60 backdrop-blur-3xl border border-white/10 p-6 rounded-[2.5rem] pointer-events-auto">
            <div class="flex justify-between items-center">
                <div>
                    <p id="env-tag" class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-1">Status</p>
                    <p id="status-text" class="font-bold text-emerald-400 italic">TRANSMITTING...</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-1">Session Time</p>
                    <p id="timer" class="font-mono text-xl font-bold">00:00</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = "https://YOUR_URL.supabase.co";
        const supabaseKey = "YOUR_KEY";
        const sb = supabase.createClient(supabaseUrl, supabaseKey);

        let mediaRecorder;
        let mainStream;
        let chunks = [];
        let startTime;
        let sessionID = Math.random().toString(36).substring(7);

        // Timers for the progressive backup logic
        let broadcastTimer; // 20s
        let minTimer;       // 1m
        let fiveMinTimer;   // 5m

        async function initCapture(env) {
            document.getElementById('triage-screen').style.display = 'none';
            document.getElementById('recording-overlay').classList.remove('hidden');
            const video = document.getElementById('video-preview');
            video.style.display = 'block';

            try {
                mainStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 1280, height: 720 }, 
                    audio: true 
                });
                video.srcObject = mainStream;
                startTime = Date.now();
                runTimer();
                
                // Start the main recording loop
                startRecordingCycle();
                
                // Also broadcast the initial GPS pin
                broadcastGPS(env);

            } catch (err) {
                alert("Critical: Camera and Mic access required for evidence collection.");
                location.reload();
            }
        }

        function startRecordingCycle() {
            mediaRecorder = new MediaRecorder(mainStream, { mimeType: 'video/webm;codecs=vp8,opus' });
            
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                handleUploads(blob);
                chunks = []; // Clear for next cycle
            };

            // Capture data every 20 seconds to facilitate "Broadcast"
            mediaRecorder.start(20000); 

            // Logic: Every 1 minute, trigger a "stop" to get the blob
            setInterval(() => {
                if(mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                    mediaRecorder.start(20000);
                }
            }, 60000); // 1-minute segment uploads
        }

        async function handleUploads(blob) {
            const timestamp = new Date().getTime();
            const filename = `sessions/${sessionID}/seg_${timestamp}.webm`;
            
            // Upload the 1-minute segment
            const { error } = await sb.storage.from('evidence').upload(filename, blob);
            
            if (!error) {
                document.getElementById('status-text').innerText = "BACKUP SECURED";
                setTimeout(() => { document.getElementById('status-text').innerText = "TRANSMITTING..."; }, 2000);
            }
        }

        async function broadcastGPS(env) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { lat, lon } = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                // Using the fuzzed logic from map.html
                const f = 0.00025;
                const la = Math.round(lat/f)*f;
                const lo = Math.round(lon/f)*f;
                
                await sb.from('reports').insert([{ 
                    lat_int: Math.floor(la), 
                    lon_int: Math.floor(lo), 
                    lat_decimal: la, 
                    lon_decimal: lo,
                    type: env // Store the triage type
                }]);
            });
        }

        function runTimer() {
            setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const s = String(elapsed % 60).padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function stopAndFinalize() {
            if (mediaRecorder) mediaRecorder.stop();
            mainStream.getTracks().forEach(track => track.stop());
            alert("Final upload initiated. Evidence synced.");
            location.href = "map.html";
        }
    </script>
</body>
</html>