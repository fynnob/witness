<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Witness | Tactical Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --apple-blue: #007AFF; --bg: #fdfdfd; --text: #1c1c1e; --glass: rgba(255, 255, 255, 0.85); --border: rgba(0, 0, 0, 0.08); }
        .dark { --bg: #000000; --text: #ffffff; --glass: rgba(28, 28, 30, 0.85); --border: rgba(255, 255, 255, 0.15); }

        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); overflow: hidden; font-family: -apple-system, sans-serif; transition: background 0.4s ease; }
        #map { position: absolute; inset: 0; z-index: 1; }
        
        /* Map Filtering for Dark Mode */
        .dark .leaflet-tile { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-tile { transition: filter 0.5s ease; }

        /* UI Overlays */
        .glass { background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--border); color: var(--text); }
        .map-ui { pointer-events: none; z-index: 1000; position: absolute; inset: 0; padding-top: env(safe-area-inset-top); }
        .map-ui > * { pointer-events: auto; }

        /* Tactical Report Button & Cooldown */
        .report-btn { position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .report-btn.cooldown { background: #000 !important; pointer-events: none; }
        #cooldown-bar { position: absolute; top: 0; right: 0; height: 100%; background: #ef4444; width: 0%; transition: none; opacity: 0.3; }

        .user-dot { width: 18px; height: 18px; background: var(--apple-blue); border: 3px solid white; border-radius: 50%; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="map-ui flex flex-col items-center h-full">
        <div class="w-full max-w-md px-5 mt-4 flex flex-col gap-3">
            <div class="glass rounded-2xl flex items-center px-4 py-1 shadow-lg">
                <input type="text" id="search-input" placeholder="Search area..." class="w-full bg-transparent border-none focus:ring-0 px-3 py-3.5 text-sm font-bold outline-none">
                <button onclick="toggleDarkMode()" class="p-2 opacity-50">üåì</button>
            </div>
        </div>

        <div class="absolute top-1/2 -translate-y-1/2 right-4 flex flex-col gap-4">
            <div class="flex flex-col glass rounded-2xl shadow-xl overflow-hidden">
                <button onclick="map.zoomIn()" class="w-12 h-12 flex items-center justify-center border-b border-black/5">+</button>
                <button onclick="map.zoomOut()" class="w-12 h-12 flex items-center justify-center">-</button>
            </div>
            <button onclick="centerOnUser()" class="w-12 h-12 glass rounded-2xl flex items-center justify-center shadow-xl">üìç</button>
        </div>

        <div class="absolute bottom-10 w-full px-8 flex justify-center">
            <button id="report-master" onclick="triggerReport()" class="report-btn w-full max-w-sm bg-red-600 text-white py-5 rounded-[22px] font-black text-lg shadow-2xl flex items-center justify-center gap-3">
                <div id="cooldown-bar"></div>
                <span id="btn-label" class="relative z-10">REPORT ICE</span>
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/simpleheat@0.4.0/simpleheat.js"></script>
    
    <script>
        const supabaseUrl = "https://qburnwsfauymwwwpmjoo.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJud3NmYXV5bXd3d3Btam9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NDk2MzUsImV4cCI6MjA4NzMyNTYzNX0.auc2wgNolEGIsIzUsEfTgyVPS-whImFRxePCtmDBbTA";
        const sb = supabase.createClient(supabaseUrl, supabaseKey);

        // --- MAP CONFIG ---
        const map = L.map('map', { zoomControl: false, attributionControl: false, preferCanvas: true })
                     .setView([38.5, -98.0], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png').addTo(map);

        let userMarker, currentCoords;
        let isCooldown = false;

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('witness_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('witness_theme') === 'dark') document.body.classList.add('dark');

        // --- GPS ---
        map.on('locationfound', (e) => {
            currentCoords = e.latlng;
            if (!userMarker) {
                userMarker = L.marker(e.latlng, { icon: L.divIcon({ className: '', html: '<div class="user-dot"></div>', iconSize: [18, 18], iconAnchor: [9, 9] }) }).addTo(map);
                map.flyTo(e.latlng, 14);
            } else {
                userMarker.setLatLng(e.latlng);
            }
        });
        map.locate({ watch: true, enableHighAccuracy: true });

        function centerOnUser() { if (currentCoords) map.flyTo(currentCoords, 14); }

        // --- SHARD DATA BURST (Efficiency Fix) ---
        async function fetchBurst() {
            const center = map.getCenter();
            const now = Date.now();
            const sixHoursAgo = new Date(now - 21600000).toISOString();

            // Calculate local shards (Integer squares)
            const shards = [
                [Math.floor(center.lat), Math.floor(center.lng)],
                [Math.floor(center.lat) + 1, Math.floor(center.lng)],
                [Math.floor(center.lat) - 1, Math.floor(center.lng)],
                [Math.floor(center.lat), Math.floor(center.lng) + 1],
                [Math.floor(center.lat), Math.floor(center.lng) - 1]
            ];

            let allReports = [];
            for (const [lat, lon] of shards) {
                const { data } = await sb.from('reports')
                                         .select('lat_decimal, lon_decimal')
                                         .eq('lat_int', lat)
                                         .eq('lon_int', lon)
                                         .gt('created_at', sixHoursAgo);
                if (data) allReports = [...allReports, ...data];
            }

            renderTacticalMarkers(allReports);
        }

        function renderTacticalMarkers(reports) {
            // Simplified marker logic to keep performance high
            // In production, use Leaflet.markercluster or canvas circles
        }

        // --- REPORT & COOLDOWN ---
        async function triggerReport() {
            if (isCooldown || !currentCoords) return;
            
            isCooldown = true;
            const btn = document.getElementById('report-master');
            const label = document.getElementById('btn-label');
            const bar = document.getElementById('cooldown-bar');

            // 1. Data Burst to Supabase
            const f = 0.00025;
            const la = Math.round(currentCoords.lat/f)*f;
            const lo = Math.round(currentCoords.lng/f)*f;

            const { error } = await sb.from('reports').insert([{
                lat_int: Math.floor(la),
                lon_int: Math.floor(lo),
                lat_decimal: la,
                lon_decimal: lo
            }]);

            if (error) {
                alert("Report failed. Check connection.");
                isCooldown = false;
                return;
            }

            // 2. UI Cooldown Animation
            btn.classList.add('cooldown');
            label.innerText = "REPORT SENT";
            
            let progress = 0;
            const duration = 60000; // 1 minute
            const interval = 100;
            
            const timer = setInterval(() => {
                progress += (interval / duration) * 100;
                bar.style.width = progress + "%";

                if (progress >= 100) {
                    clearInterval(timer);
                    isCooldown = false;
                    btn.classList.remove('cooldown');
                    bar.style.width = "0%";
                    label.innerText = "REPORT ICE";
                }
            }, interval);
        }

        map.on('moveend', fetchBurst);
        fetchBurst();
    </script>
</body>
</html>